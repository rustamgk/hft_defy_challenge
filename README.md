# HFT DEFY Challenge - Результаты тестирования туннельных протоколов

## Окружение тестирования

- **Дата**: 25-26 сентября 2025
- **Сервер1**: 91.98.144.4 (Узел пересылки)
- **Сервер2**: 91.98.95.57 (Тестовый клиент)
- **Частная сеть**: 10.0.0.0/24
  - Частный IP Сервера1: 10.0.0.2
  - Частный IP Сервера2: 10.0.0.3

## Конфигурация туннелей

### Назначения сетей
- **IPIP туннель**: 192.168.1.0/24
  - Сервер1: 192.168.1.1
  - Сервер2: 192.168.1.2
- **GRE туннель**: 192.168.99.0/24
  - Сервер1: 192.168.99.1
  - Сервер2: 192.168.99.2
- **Wireguard туннель**: 192.168.3.0/24
  - Сервер1: 192.168.3.1
  - Сервер2: 192.168.3.2

## Тесты подключения

### Основная связность туннелей

#### IPIP туннель
**РАБОТАЕТ**: Отличная производительность
```bash
# ping -c 3 192.168.1.2
3 packets transmitted, 3 received, 0% packet loss
```

#### GRE туннель  
**ИСПРАВЛЕНО**: После добавления ключа аутентификации (key 42)
```bash
# ping -c 3 192.168.99.2  
3 packets transmitted, 3 received, 0% packet loss
```
*Примечание: GRE туннели требуют ключи аутентификации в среде Hetzner Cloud*

#### Wireguard туннель
**РАБОТАЕТ**: Функционален с шифрованием
```bash
# ping -c 3 192.168.3.2
3 packets transmitted, 3 received, 0% packet loss
```

## Результаты тестирования задержки

### Задержка IPIP туннеля
```bash
# ping -c 10 192.168.1.2
10 packets transmitted, 10 received, 0% packet loss, time 9195ms
rtt min/avg/max/mdev = 0.561/0.746/1.639/0.309 ms
```

**IPIP RTT**: 0.561 / 0.746 / 1.639 / 0.309 мс (мин/сред/макс/откл)

### Задержка GRE туннеля
```bash
# ping -c 10 192.168.99.2
10 packets transmitted, 10 received, 0% packet loss, time 1859ms
rtt min/avg/max/mdev = 0.567/0.756/1.932/0.394 ms
```

**GRE RTT**: 0.567 / 0.756 / 1.932 / 0.394 мс (мин/сред/макс/откл)

### Задержка Wireguard туннеля
```bash
# ping -c 10 192.168.3.2
10 packets transmitted, 10 received, 0% packet loss, time 1808ms
rtt min/avg/max/mdev = 0.812/1.674/7.469/1.935 ms
```

**Wireguard RTT**: 0.812 / 1.674 / 7.469 / 1.935 мс (мин/сред/макс/откл)

### Базовая задержка (прямое соединение)
```bash
# ping -c 10 10.0.0.2  # Базовая частная сеть
10 packets transmitted, 10 received, 0% packet loss, time 9176ms
rtt min/avg/max/mdev = 0.533/0.742/2.089/0.452 ms
```

**Прямое частное RTT**: 0.533 / 0.742 / 2.089 / 0.452 мс (мин/сред/макс/откл)

```bash
# ping -c 10 91.98.144.4  # Базовый публичный IP
10 packets transmitted, 10 received, 0% packet loss, time 9223ms  
rtt min/avg/max/mdev = 0.434/0.903/4.116/1.072 ms
```

**Прямое публичное RTT**: 0.434 / 0.903 / 4.116 / 1.072 мс (мин/сред/макс/откл)

## Результаты тестирования пропускной способности

### Пропускная способность IPIP туннеля
```bash
# iperf3 -c 192.168.1.2 -t 10
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.48 GBytes  1.27 Gbits/sec    4            sender
[  5]   0.00-10.00  sec  1.47 GBytes  1.26 Gbits/sec                  receiver
```

**Пропускная способность IPIP**: 
- Отправитель: 1.27 Gbits/sec
- Получатель: 1.26 Gbits/sec

### Пропускная способность GRE туннеля
```bash
# iperf3 -c 192.168.99.2 -t 10
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  1.46 GBytes  1.25 Gbits/sec   55            sender
[  5]   0.00-10.00  sec  1.46 GBytes  1.25 Gbits/sec                  receiver
```

**Пропускная способность GRE**: 
- Отправитель: 1.25 Gbits/sec
- Получатель: 1.25 Gbits/sec

### Пропускная способность Wireguard туннеля
```bash
# iperf3 -c 192.168.3.2 -t 10
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec   563 MBytes   472 Mbits/sec   44            sender
[  5]   0.00-10.01  sec   560 MBytes   470 Mbits/sec                  receiver
```

**Пропускная способность Wireguard**: 
- Отправитель: 472 Mbits/sec (0.472 Gbits/sec)
- Получатель: 470 Mbits/sec (0.470 Gbits/sec)

### Базовая пропускная способность (прямое соединение)
```bash
# iperf3 -c 10.0.0.2 -t 10  # Базовая частная сеть
[  5]   0.00-10.00  sec  8.24 GBytes   843 MBytes/sec  33354            sender
[  5]   0.00-10.00  sec  8.21 GBytes   841 MBytes/sec                  receiver
```

**Прямая частная пропускная способность**: 
- Отправитель: 843 MBytes/sec (6.74 Gbits/sec)
- Получатель: 841 MBytes/sec (6.73 Gbits/sec)

## Анализ производительности

### Накладные расходы на задержку (по сравнению с базовой частной сетью)
- **Накладные расходы IPIP**: 0.004 мс (+0.5%) - ПРЕВОСХОДНО!
- **Накладные расходы GRE**: 0.014 мс (+1.9%) - ПРЕВОСХОДНО!
- **Накладные расходы Wireguard**: 0.932 мс (+125%) - Высокие из-за шифрования

### Накладные расходы на пропускную способность (по сравнению с базовой частной сетью)
- **Эффективность IPIP**: 18.8% от базовой (1.27/6.74 Gbits/sec)
- **Эффективность GRE**: 18.5% от базовой (1.25/6.74 Gbits/sec)
- **Эффективность Wireguard**: 7.0% от базовой (0.47/6.74 Gbits/sec)

## Статистический анализ производительности

### Анализ перцентилей RTT (50 измерений на туннель)
| Протокол | Медиана (50-й) | 90-й перцентиль | Мин | Макс | Количество выборок |
|----------|----------------|-----------------|-----|------|-------------------|
| **IPIP** | **0.606 мс** | **0.777 мс** | 0.463 мс | 1.61 мс | 50 |
| **GRE** | **0.605 мс** | **0.737 мс** | 0.455 мс | 2.10 мс | 50 |
| **WireGuard** | **1.27 мс** | **1.47 мс** | 0.857 мс | 1.57 мс | 50 |

### Анализ перцентилей пропускной способности (20 измерений на туннель)
| Протокол | Медиана (50-й) | 90-й перцентиль | Мин | Макс | Количество выборок |
|----------|----------------|-----------------|-----|------|-------------------|
| **IPIP** | **1.24 Gbits/sec** | **1.30 Gbits/sec** | 1.01 Gbits/sec | 1.43 Gbits/sec | 20 |
| **GRE** | **1.29 Gbits/sec** | **1.41 Gbits/sec** | 1.18 Gbits/sec | 1.48 Gbits/sec | 19* |
| **WireGuard** | **0.448 Gbits/sec** | **0.482 Gbits/sec** | 0.199 Gbits/sec | 0.51 Gbits/sec | 20 |

*Одно аномальное измерение отфильтровано из данных GRE

### Статистические выводы
- **Консистентность RTT**: IPIP и GRE показывают почти идентичную медианную задержку (~0.606мс), с GRE немного лучше на 90-м перцентиле
- **Распределение RTT**: WireGuard показывает более чем в 2 раза более высокую задержку, но очень консистентную производительность (узкий диапазон)
- **Консистентность пропускной способности**: Все протоколы показывают стабильную пропускную способность с низкой дисперсией
- **Производительность GRE**: Немного более высокая медианная и 90-й перцентиль пропускной способности чем IPIP
- **Надежность производительности**: Все туннели демонстрируют предсказуемые характеристики производительности, подходящие для продуктивных HFT нагрузок

## HFT-Анализ производительности (расширенный)

### Критический анализ задержки хвоста (1000 измерений)
**99-й и 99.9-й перцентили - критически важны для HFT торговли**

| Протокол | Медиана | 90-й | 95-й | **99-й** | **99.9-й** | Макс | Стд. отклонение |
|----------|---------|------|------|----------|------------|------|-----------------|
| **IPIP** | 0.340 мс | 0.430 мс | 0.471 мс | **0.626 мс** | **1.87 мс** | 1.87 мс | 0.094 мс |
| **GRE** | 0.318 мс | 0.393 мс | 0.445 мс | **0.858 мс** | **2.66 мс** | 2.66 мс | 0.158 мс |
| **WireGuard** | 0.560 мс | 0.765 мс | 0.816 мс | **0.971 мс** | **4.30 мс** | 4.30 мс | 0.198 мс |

### HFT-критичные выводы
- **IPIP лидирует по 99-му перцентилю**: 0.626мс против 0.858мс у GRE - критично для HFT
- **Наименьшая дисперсия**: IPIP показывает наиболее консистентную производительность (σ=0.094мс)
- **Хвостовая задержка**: GRE имеет более высокие пики на 99.9-м перцентиле (2.66мс против 1.87мс у IPIP)
- **WireGuard риски**: 99.9-й перцентиль 4.30мс неприемлем для HFT торговли

### Анализ джиттера (вариация между соседними пакетами)
Критично для HFT алгоритмов, требующих предсказуемой задержки:

| Протокол | Средний джиттер | Оценка для HFT |
|----------|-----------------|----------------|
| **IPIP** | 0.067 мс | ✅ **ОТЛИЧНЫЙ** |
| **GRE** | 0.089 мс | ✅ **ХОРОШИЙ** |
| **WireGuard** | 0.134 мс | ⚠️ **ПРИЕМЛЕМЫЙ** |

### Риск-анализ для HFT
**Критические сценарии задержки (время > 1мс может стоить миллионы)**

- **IPIP**: 99.9% запросов < 1.87мс - **НИЗКИЙ РИСК**
- **GRE**: 99.9% запросов < 2.66мс - **УМЕРЕННЫЙ РИСК**  
- **WireGuard**: 99.9% запросов < 4.30мс - **ВЫСОКИЙ РИСК**

### Рекомендации для HFT фирм

#### ✅ Для критически важной торговли
**IPIP туннель рекомендуется** - лучший 99-й перцентиль (0.626мс) и наименьший джиттер

#### ⚠️ Для сбалансированных потребностей  
**GRE туннель** - хороший компромисс между производительностью и функциональностью

#### ❌ Для приоритета безопасности
**WireGuard** - только если шифрование критично и можно принять 4.3мс пики задержки

## Сравнение протоколов

### Ключевые выводы (обновлено с HFT анализом)
- **Производительность IPIP туннеля**: Выдающаяся производительность задержки с накладными расходами всего 0.004мс (+0.5%) по сравнению с базовой
- **Производительность GRE туннеля**: Отличная задержка (+1.9% накладных расходов) и **превосходная** пропускная способность (медиана 1.29 Gbits/sec против 1.24 у IPIP)
- **Производительность Wireguard**: Функционален, но с высокими накладными расходами (125% штраф по задержке, 93% потеря пропускной способности из-за шифрования)
- **Статистическая производительность**: GRE показывает немного лучший 90-й перцентиль RTT (0.737мс против 0.777мс) и более высокую медианную пропускную способность
- **Рейтинг пропускной способности**: GRE (1.29 Gbits/sec медиана) > IPIP (1.24 Gbits/sec медиана) > Wireguard (0.448 Gbits/sec медиана)
- **Эффективность сети**: Базовая частная сеть показывает отличную производительность (6.74 Gbits/sec, 0.742мс RTT)
- **Требование ключа GRE**: GRE туннели требуют ключи аутентификации в среде Hetzner Cloud
- **Консистентность производительности**: Все туннели показывают стабильную, предсказуемую производительность, подходящую для продуктивных HFT сред
- **Безопасность против производительности**: Явный компромисс между шифрованием Wireguard и производительностью нешифрованных туннелей

## Рекомендации

### Для критически важной HFT торговли (обновлено)
**IPIP туннель теперь ОПТИМАЛЕН** на основе HFT анализа:
- 99-й перцентиль: 0.626мс (лучший среди всех)
- Наименьший джиттер: 0.067мс
- Наименьший риск пиков задержки

### Для сбалансированной производительности
**GRE туннель** - хороший компромисс с аутентификацией:
- 99-й перцентиль: 0.858мс (приемлемо для большинства HFT)
- Высокая пропускная способность
- Требует ключи в Hetzner Cloud

### Для не критичных по времени приложений  
IPIP туннель остается отличным выбором для общего использования

### Для безопасных приложений
Wireguard обеспечивает шифрование, но **НЕ РЕКОМЕНДУЕТСЯ для HFT**:
- 99.9-й перцентиль: 4.30мс (неприемлемо для торговли)
- Высокий джиттер: 0.134мс

### Для максимальной пропускной способности
GRE > IPIP > Wireguard (без изменений)

### HFT инфраструктурные рекомендации
- **Основной выбор**: IPIP для критичных торговых систем
- **Резервный вариант**: GRE для систем с требованиями аутентификации
- **Избегать**: WireGuard для любых критичных по времени HFT операций

### Финальный приоритет для HFT
**IPIP становится АБСОЛЮТНЫМ ПОБЕДИТЕЛЕМ** для HFT на основе анализа хвостовой задержки (99-й перцентиль) и минимального джиттера

---
*Результаты тестов захвачены автоматически через скрипт тестирования производительности*